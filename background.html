<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"> 
<head>
	<title>SharkZapper Background Page</title>
	<script type="text/javascript">
	// Global variables
	var gsTabs = [];
	var notifications = [];
	var debug = false;
	var pinnedPopup;
	var pinnedPopupOpen = false;
	var interactionPopup;
	var interactionPopupOpen = false;

	// Get all open Grooveshark tabs, then call callbacks
	function get_gs_tab(success_callback, fail_callback, arg) {
		chrome.windows.getAll({'populate':true}, function(win) {
			gsTabs = [];
			for (wi in win) {
				for (ti in win[wi].tabs) {
	 				if(win[wi].tabs[ti].url.indexOf('http://listen.grooveshark.com/')==0) {
						gsTabs.push(win[wi].tabs[ti].id);
	 				}
	 			}
	 		}
			if(gsTabs.length > 0 && typeof success_callback == "function") {
				success_callback(arg);
			} else if(typeof fail_callback == "function") {
				fail_callback(arg);
			} 
	 	});
	}

	// Inject our content scripts into the first grooveshark tab (should not be required after plugin is loaded due to manifest)
	function inject_scripts() {
		if (gsTabs.length > 0) {
			chrome.tabs.executeScript(gsTabs[0], {'file':'jquery-1.4.4.min.js'});		
			chrome.tabs.executeScript(gsTabs[0], {'file':'sharkzapper.js'});
			if (debug) console.log('Injected scripts into existing tab #' + gsTabs[0]);
		}
	}

	// Open a new grooveshark tab or show the currently open one if there is one
	function open_gs_tab(url) {
		if (gsTabs.length == 0) {
			if (url) {
				chrome.tabs.create({url:'http://listen.grooveshark.com/' + url});
			} else {
				chrome.tabs.create({url:'http://listen.grooveshark.com/'});
			}
		} else {
		    if (url) {
		        // Ensure that we only update url if it is different
		        chrome.tabs.get(gsTabs[0], function(url){ return function(tab) {
		            if (tab.url == 'http://listen.grooveshark.com/' + url) {
		                chrome.tabs.update(gsTabs[0], {'selected':true});
	                } else {
	                    chrome.tabs.update(gsTabs[0], {'url':'http://listen.grooveshark.com/' + url, 'selected':true});
                    }
		        }}(url));
			} else {
			    chrome.tabs.update(gsTabs[0], {'selected':true});
			}
		}
	}

	// Respond to requests
	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
		    // Print requests to the console in debug mode
			if (debug) console.log("sharkzapper:","<<<",request.command,request);
			
			// Ignore any requests without a command
			if (!request.command) return;
			
			// Pass through cross events (ie. contentscript -> popup, vise-versa)
			if (sender.tab && sender.tab.id == gsTabs[0]) { // Check that only events from the first open tab 
				chrome.extension.sendRequest(request); 
				if (debug) console.log("sharkzapper:",">E>",request.command,request);
			} else if (gsTabs.length > 0) {                 // Only send events to the first open tab (if available)
				chrome.tabs.sendRequest(gsTabs[0], request); 
				if (debug) console.log("sharkzapper:",">T>",request.command,request);
			}
			
			// Handle commands - note that this is not all the commands, merely ones that the background page needs to do something with
			switch (request.command) {
		        // This is sent each time a popup is open, we give some initialisation settings such as enabled, tabId, etc.
				case 'popupInit':
					if (debug) console.log('Got popup init, re-checking tabs');
					get_gs_tab(function(){
						chrome.extension.sendRequest({"command":"popupUpdate","enabled":true,"tabId":gsTabs[0],"pinnedPopupOpen":pinnedPopupOpen});
						chrome.tabs.sendRequest(gsTabs[0], {"command":"updateStatus"});
					},respond_callback({"command":"popupUpdate","enabled":false,"pinnedPopupOpen":pinnedPopupOpen}));
					break;
				
				// This is sent from the popup to open the current grooveshark tab or create a new one
				// The url is appended to the end http://listen.grooveshark.com/
				case 'openGSTab':
					open_gs_tab(request.url);
					break;
					
				// This is sent from a content script to check how many tabs are currently open
				// This message is sent to ALL grooveshark tabs EXCEPT the first, so other tabs can display a warning
				case 'getTabCount':
					get_gs_tab(function(){
						for (i=1;i<gsTabs.length;i++) {
							chrome.tabs.sendRequest(gsTabs[i], {"command":"tabCount", "tabCount": gsTabs.length});
						}
						if (debug) console.log("sharkzapper:",">ALLT>",request.command, request);
					});
					break;
					
				// This is sent from a content script to open the current grooveshark tab AND close the sender's tab
				case 'firstTabNavigate':
					chrome.tabs.remove(sender.tab.id);
					open_gs_tab();
					break;
					
				// This is sent from a content script whenever grooveshark sends a notification
				// Notifications are queued into notifications array, and only display for 5000ms
				case 'notification':
					chrome.tabs.get(gsTabs[0], function(request){ return function(tab){
						if (tab.selected) return; //ignore notifications if tab is open
						if (window.webkitNotifications) {
							notification = window.webkitNotifications.createNotification('','grooveshark',request.message); 
							notification.ondisplay = function() { setTimeout(function(){ notifications.shift().cancel();}, 5000); };
							notification.show();
							notifications.push(notification);
						}
					}}(request));
					break;
					
				// This is sent from a popup to "pin" the popup by creating a long-living HTML notification
				case 'pinPopup':
				    if (!pinnedPopupOpen && window.webkitNotifications) {
				        pinnedPopup = window.webkitNotifications.createHTMLNotification('sharkzapper_popup.html#notification');
				        pinnedPopup.ondisplay = function(){pinnedPopupOpen = true;};
				        pinnedPopup.onclose = function(){pinnedPopupOpen = false;};
				        pinnedPopup.show();
				    }
				    break;
			    
			    // This is sent from a content script many times a second. Most processing for this is done in the popup,
			    // however we also set the title of the browser action to the song / artist name
			    case 'statusUpdate':
			        if (request.currentSong) {
    			        chrome.browserAction.setTitle({"title":request.currentSong.SongName + "\n" + request.currentSong.ArtistName});
			        } else { 
                        chrome.browserAction.setTitle({"title":"SharkZapper"});
                    }
                    break;
                    
                // This is sent from a content script when the interactionTime popup appears
                // We then recreate this popup as a notification to ensure the user sees it
                case 'interactionTimePrompt':
                    if (!interactionPopupOpen && window.webkitNotifications) {
                        interactionPopup = window.webkitNotifications.createHTMLNotification('sharkzapper_interactiontime.html');
                        interactionPopup.ondisplay = function(){interactionPopupOpen = true;};
				        interactionPopup.onclose = function(){interactionPopupOpen = false;};
				        interactionPopup.show();
                    }
                    break;
                    
                // This is sent from the interactionTime notification when the user clicks "Resume"
                case 'interactionTimeResume':
                    if (interactionPopupOpen) interactionPopup.cancel();
                    break;
			}
		}
	);
	
	// simple function to make a callback that sends a request - see popupInit code
	function respond_callback(response) {
		return function(){chrome.extension.sendRequest(response)};
	}
	
	// Inject all currently open tabs with our content script
	get_gs_tab(inject_scripts); 
	</script>
</head>
<body>
	
</body>
</html>
